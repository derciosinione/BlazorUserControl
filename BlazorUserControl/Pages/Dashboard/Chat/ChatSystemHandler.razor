@using Application
@using Application.Modules.R2Y.Repositories.Interface.Chat
@using Application.Modules.R2Y.Repositories.Interface.Users
@using Application.Provider
@using FluentResults
@using StrawberryShake
@implements IDisposable
@implements IObserver<IOperationResult<IOnMessageReceivedResult>>

@code {
    [Inject] public IUserService UserService { get; set; } = default!;
    [Inject] public IChatService ChatService { get; set; } = default!;
    [Inject] public AppAuthStateProvider AuthStateProvider { get; set; } = default!;

    // Data Sources
    public IReadOnlyList<IGetAllUsers_AllUsers>? AllUsers { get; set; } = new List<IGetAllUsers_AllUsers>();
    public IReadOnlyList<IGetAllUserRoom_AllChatRoomByUserEmail>? AllChats { get; set; } = new
    List<IGetAllUserRoom_AllChatRoomByUserEmail>();
    public List<IGetChatMessages_AllMessagesByChatRoomId_Data> Messages { get; set; } = new();

    private IDisposable? _messageSubscription;

    // State
    public bool IsLoadingUsers { get; set; } = false;
    public bool IsLoadingChats { get; set; } = false;
    public bool IsLoadingMessages { get; set; } = false;
    public string CurrentUserEmail { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        var userInfo = await AuthStateProvider.GetUserInfo();
        if (userInfo != null)
        {
            CurrentUserEmail = userInfo.Email;
            await LoadChats();

            // Subscribe to real-time messages
            _messageSubscription = ChatService.SubscribeToMessages(CurrentUserEmail)
            .Subscribe(this);
        }
    }

    private void HandleIncomingMessage(IOnMessageReceived_OnMessageReceived msg)
    {
        InvokeAsync(async () =>
        {
            await LoadChats(); // Always safe to update sidebar
            await OnNewMessageReceived(msg); 
            StateHasChanged();
        });
    }

    // Allow child to hook into this
    protected virtual Task OnNewMessageReceived(IOnMessageReceived_OnMessageReceived msg)
    {
        return Task.CompletedTask;
    }


    protected async Task LoadAllUsers()
    {
        if (AllUsers!.Any()) return;

        IsLoadingUsers = true;
        StateHasChanged();

        var result = await UserService.GetAllUsers();
        if (result is { IsSuccess: true, Value: not null })
        {
            AllUsers = result.Value;
        }

        IsLoadingUsers = false;
        StateHasChanged();
    }

    private async Task LoadChats()
    {
        IsLoadingChats = true;
        StateHasChanged();

        var result = await ChatService.GetAllUserRoom(CurrentUserEmail);
        if (result is { IsSuccess: true, Value: not null })
        {
            AllChats = result.Value;
        }

        IsLoadingChats = false;
        StateHasChanged();
    }

    protected async Task LoadMessages(Guid roomId)
    {
        IsLoadingMessages = true;
        StateHasChanged();

        var result = await ChatService.GetMessagesAsync(roomId, 1, 20);

        Messages = result.IsSuccess 
            ? result.Value.Data.OrderBy(m => m.SentAt).ToList() 
            : new List<IGetChatMessages_AllMessagesByChatRoomId_Data>();

        IsLoadingMessages = false;
        StateHasChanged();
    }

    protected async Task SendMessage(Guid roomId, string content)
    {
        if (string.IsNullOrWhiteSpace(content)) return;

        var result = await ChatService.SendMessageAsync(roomId, CurrentUserEmail, content);

        if (result.IsSuccess)
        {
            await LoadMessages(roomId);
        }
    }



    protected async Task DeleteMessage(Guid roomId, Guid messageId)
    {
        var result = await ChatService.DeleteMessageAsync(roomId, messageId, CurrentUserEmail);

        if (result.IsSuccess && result.Value)
        {
            // Remove from local list if present
            var msg = Messages.FirstOrDefault(m => m.Id == messageId);
            if (msg != null)
            {
                Messages.Remove(msg);
                StateHasChanged();
            }
        }
    }

    protected async Task<Guid?> CreatePrivateChat(string targetUserEmail)
    {
        var result = await ChatService.CreatePrivateRoomAsync(targetUserEmail, CurrentUserEmail);

        if (!result.IsSuccess) return null;

        await LoadChats();
        return result.Value.Data?.Id;
    }

    public void Dispose()
    {
        _messageSubscription?.Dispose();
    }

    public void OnCompleted()
    {
    }

    public void OnError(Exception error)
    {
    }

    public void OnNext(IOperationResult<IOnMessageReceivedResult> result)
    {
        if (result.Data != null)
        {
            var msg = result.Data.OnMessageReceived;
            HandleIncomingMessage(msg);
        }
    }
}